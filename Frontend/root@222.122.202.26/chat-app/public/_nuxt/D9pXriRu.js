import{g as B,z as C,r as m,q as D,k as h,A as I,B as $,C as R,D as S,c as f,a as o,F as T,y as j,l as x,v as E,p as L,E as U,o as p,G as z,m as F,t as v}from"./CJ4QiOoU.js";import{l as N}from"./CA1CrNgP.js";import{u as V}from"./BxxLc4LK.js";const q={class:"chat-container"},G={class:"message-header"},H=["src"],J={class:"nickname"},K={class:"small"},O={class:"content"},ee=B({__name:"[roomId]",setup(P){const _=U(),k=C(),c=D(),n=V(),g=Number(k.params.roomId),l=m([]),u=m(""),a=N(`${c.public.apiBase}`,{withCredentials:!0}),d=m(null),r=m({});async function A(e){if(r.value[e])return r.value[e];try{const t=await(await fetch(`${c.public.apiBase}/api/users/${e}/profile`)).json(),i=`${c.public.apiBase}/uploads/profiles/${t.profileImage}`;return r.value[e]=i,i}catch{r.value[e]=`${c.public.apiBase}/uploads/profiles/default-avatar.jpg`;return}}function b(){a.on("previousMessages",e=>{l.value=Array.isArray(e)?e:[]}),a.on("receiveMessage",e=>{l.value.push(e)}),a.on("roomMembers",e=>{console.log("room members:",e)})}function M(){n.userid&&(b(),a.emit("joinRoom",{roomId:g,userId:n.userid}))}h(()=>n.userid,e=>{e?M():_.push("/")},{immediate:!0}),h(()=>l.value,e=>{e.forEach(s=>{r.value[s.userid]||A(s.userid)})},{deep:!0});const w=I(()=>{const e=[];for(const s of l.value){const t=e[e.length-1];if(t&&t.userid===s.userid){const i=new Date(t.createdAt).getTime();if(new Date(s.createdAt).getTime()-i<6e4){t.content=t.content+`
`+s.content,t.createdAt=s.createdAt;continue}}e.push({userid:s.userid,username:s.username,nickname:s.nickname,content:s.content,createdAt:s.createdAt})}return e});$(async()=>{await R(),d.value&&(d.value.scrollTop=d.value.scrollHeight)}),S(()=>{a.off("previousMessages"),a.off("receiveMessage"),a.off("roomMembers"),a.disconnect()});function y(){!u.value.trim()||!n.userid||(a.emit("sendMessage",{roomId:g,userId:n.userid,content:u.value}),u.value="")}return(e,s)=>(p(),f("div",q,[o("div",{class:"messages",ref_key:"messagesContainer",ref:d},[(p(!0),f(T,null,j(w.value,(t,i)=>(p(),f("div",{key:i,class:z(["message",t.userid===F(n).userid?"me":"other"])},[o("div",G,[o("img",{class:"avatar",src:r.value[t.userid],alt:"avatar"},null,8,H),o("strong",J,v(t.nickname),1),o("div",K,v(new Date(t.createdAt).toLocaleString()),1)]),o("div",O,v(t.content),1)],2))),128))],512),o("form",{onSubmit:L(y,["prevent"]),class:"input-form"},[x(o("input",{"onUpdate:modelValue":s[0]||(s[0]=t=>u.value=t),placeholder:"메시지 입력...",autocomplete:"off"},null,512),[[E,u.value]]),s[1]||(s[1]=o("button",{type:"submit"},"전송",-1))],32)]))}});export{ee as default};
